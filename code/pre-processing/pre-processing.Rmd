---
title: "pre-processing"
author: "Thu Tran"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readxl)
library(tidyr)
library(dplyr)
library(tidyr)
library(readxl)
library(ggplot2)
library(shiny)
library(stringr)
```

# Victoria 
source: https://www.cancervic.org.au/research/vcr

```{r data}
# source: https://www.cancervic.org.au/research/vcr
df_case <- read_excel("../../data/raw/Melanoma-in-Victoria-1982-2021.xlsx", sheet = "Incidence", skip = 4)
head(df_case)
df_disparities <- read_excel("../../data/raw/Melanoma-in-Victoria-1982-2021.xlsx", sheet = "Disparities in incidence ", skip = 4)
head(df_disparities)
df_mortality <- read_excel("../../data/raw/Melanoma-in-Victoria-1982-2021.xlsx", sheet = "Mortality", skip = 4)
head(df_mortality)
df_survival <- read_excel("../../data/raw/Melanoma-in-Victoria-1982-2021.xlsx", sheet = "Survival", skip = 4)
head(df_survival)
```

```{r incidence}
# Filter for cases only and drop unnecessary columns
data_cases <- df_case %>% 
  filter(Measure == "Cases") %>% 
  select(Year, Sex, `0-4`:`85+`)

# Convert df_case to long format
data_long <- data_cases %>% 
  pivot_longer(cols = `0-4`:`85+`, names_to = "AgeGroup", values_to = "Cases")

# Save data_long to a CSV file
write.csv(data_long, file = "../../data/clean/cleaned-incidence-Melanoma-in-Victoria-1982-2021.csv", row.names = FALSE)

data_long
```




```{r disparities}

# Remove rows with NA in "Period" column
df_disparities <- df_disparities %>% filter(!is.na(Period))

# Check if rows match the pattern
matched_rows <- df_disparities %>% 
  filter(str_detect(`Standardised incidence ratio`, "^\\d+\\.?\\d* \\[\\d+\\.?\\d*\\-\\d+\\.?\\d*\\]$"))

# Check if there are any non-matching rows
if (nrow(matched_rows) < nrow(df_disparities)) {
  problematic_rows <- df_disparities %>% 
    anti_join(matched_rows)
  print(problematic_rows)
} else {
  print("No problematic rows found!")
}


# Extract SIR value and Confidence Interval (CI)
disparities_data_long <- df_disparities %>%
  mutate(
    SIR = str_extract(`Standardised incidence ratio`, "^\\d+\\.?\\d*"), # Extracting the leading numeric value
    CI = str_extract(`Standardised incidence ratio`, "\\[.*\\]") # Extracting the value inside brackets
  ) %>%
  separate(CI, into = c("CI_low", "CI_high"), sep = "-") %>%
  mutate(
    SIR = as.numeric(SIR),
    CI_low = as.numeric(str_replace_all(CI_low, "\\[|\\s", "")), # Removing bracket and spaces
    CI_high = as.numeric(str_replace_all(CI_high, "\\]|\\s", "")) # Removing bracket and spaces
  ) %>%
  select(-`Standardised incidence ratio`)

write.csv(disparities_data_long, file = "../../data/clean/cleaned-disparities-Melanoma-in-Victoria-1982-2021.csv", row.names = FALSE)

disparities_data_long
```


```{r mortality}
# Convert from wide format to long format
mortality_data_long <- df_mortality %>%
  gather(`Age Group`, `Value`, `0-4`:`85+`) %>%
  filter(Measure != "Deaths") %>% # To visualize only Age specific rate
  select(-Measure)

write.csv(mortality_data_long, file = "../../data/clean/cleaned-mortality-Melanoma-in-Victoria-1982-2021.csv", row.names = FALSE)
mortality_data_long
```

Interactive Controls: Users can now select a specific gender and age group to view using the dropdown menus. By default, all data will be shown.
Tooltip: Hovering over the plot will show specific data points, providing a more interactive experience.
Help Text: Some explanatory text has been added for context.

```{r}
library(shiny)
library(plotly)

# Colorblind-friendly colors
cb_palette <- c('Males' = '#E69F00', 'Females' = '#56B4E9') # Okabe and Ito palette

ui <- fluidPage(
  titlePanel("Melanoma Incidence in Victoria (1982-2021)"),
  sidebarLayout(
    sidebarPanel(
      selectInput("sex", "Select Gender:", choices = unique(data_long$Sex), selected = c("Males", "Females"), multiple = TRUE),
      selectInput("ageGroup", "Select Age Group:", choices = unique(data_long$AgeGroup), selected = "20-24", multiple = TRUE),
      wellPanel(
        h4("Definitions:"),
        tags$ul(
          tags$li("Age-standardised rate (ASR): Provides the capacity to compare..."),
          tags$li("Crude rate (CR): The number of diagnoses..."),
          tags$li("Age-specific rate: Number of diagnoses..."),
          tags$li("Standardised incidence ratio (SIR): A Standardised Incidence Ratio..."),
        )
      )
    ),
    mainPanel(
      plotlyOutput("timeSeriesPlot"),
      tags$p("Source: Victorian Cancer Registry (2022)", style = "color:gray;")
    )
  )
)

server <- function(input, output) {
  
  filtered_data <- reactive({
    data_long[data_long$Sex %in% input$sex & data_long$AgeGroup %in% input$ageGroup,]
  })

  output$timeSeriesPlot <- renderPlotly({
    plot_ly(data = filtered_data(), x = ~Year, y = ~Cases, color = ~Sex, colors = cb_palette, type = "scatter", mode = "lines", 
            hoverinfo = "text",
            text = ~paste("Year:", Year, "<br>Sex:", Sex, "<br>Age Group:", AgeGroup, "<br>Cases:", Cases)) %>%
      layout(title = "Yearly Melanoma Cases in Victoria by Gender",
             xaxis = list(title = "Year"),
             yaxis = list(title = "Number of Cases")) %>%
      config(displayModeBar = FALSE) # Hides the plotly default toolbox
  })
}

shinyApp(ui = ui, server = server)

```


```{r}
library(shiny)
library(plotly)
library(dplyr)

ui <- fluidPage(
  titlePanel("Disparities in Melanoma (ICD-10: C43) Incidence (2018-2020)"),
  sidebarLayout(
    sidebarPanel(
      selectInput("characteristic", "Select Characteristic", unique(disparities_data_long$Characteristic)),
      selectInput("sex", "Select Sex", unique(disparities_data_long$Sex)),
      tags$br(),
      tags$h4("Disparity Groups Explanation:"),
      tags$p("Socio-economic quintile", tags$br(),
             "[Reference population - Those living in areas classified as the middle (3rd) socio-economic quintile]", tags$br(),
             "... explanation for socio-economic quintile ...", tags$br(),
             "For more information, please refer to the Australian Bureau of Statistics website."),
      tags$p("Remoteness", tags$br(),
             "[Reference population - Those living in major cities]", tags$br(),
             "... explanation for Remoteness ..."),
      tags$p("Aboriginal and/or Torres Strait Islanders", tags$br(),
             "[Reference population - Those who do not identify as Aboriginal and/or Torres Strait Islander]", tags$br(),
             "... explanation for Aboriginal and/or Torres Strait Islanders ..."),
      tags$p("Integrated Cancer Service (ICS)", tags$br(),
             "[Reference population - The Victorian average]", tags$br(),
             "... explanation for ICS ..."),
      tags$p("Country of birth", tags$br(),
             "[Reference population - Those born in Australia]", tags$br(),
             "... explanation for Country of birth ...", tags$br(),
             "ABS = Australian Bureau of Statistics"),
      # Custom Legend
      tags$br(),
      tags$h4("Legend Explanation:"),
      tags$div(style = "display: inline-block; vertical-align: middle; margin-right: 5px;",
               tags$span(style = "display: inline-block; width: 15px; height: 15px; background-color: #E69F00; border-radius: 50%;")),
      tags$span("Orange Circle: Represents the Standardised Incidence Ratio (SIR)"),
      tags$br(),
      tags$div(style = "display: inline-block; vertical-align: middle; margin-right: 5px;",
               tags$span(style = "display: inline-block; width: 15px; height: 2px; background-color: #56B4E9;")),
      tags$span("Blue Line: Represents the Confidence Interval (CI) for the SIR"),
      tags$p("Source: Victorian Cancer Registry (2022)")
    ),
    mainPanel(
      plotlyOutput("plotlyBarPlot")
    )
  )
)

server <- function(input, output) {
  
  output$plotlyBarPlot <- renderPlotly({
    df_selected <- disparities_data_long %>% 
      filter(Characteristic == input$characteristic & Sex == input$sex) %>%
      drop_na(SIR)
    
    p <- df_selected %>% 
      plot_ly(x = ~Subgroup,
              y = ~SIR, 
              type = 'scatter', 
              mode = 'markers',
              size = ~SIR,
              error_y = list(type = "data", array = ~CI_high - SIR, arrayminus = ~SIR - CI_low),
              marker = list(color = '#E69F00', sizemode = "diameter"),
              text = ~paste0("Subgroup: ", Subgroup, "<br>Sex: ", Sex, "<br>Observed: ", Observed, 
                             "<br>Expected: ", Expected, "<br>SIR: ", SIR, "<br>CI: (", CI_low, "-", CI_high, ")"),
              hoverinfo = "text") %>%
      layout(title = paste("Disparity in", input$characteristic, "by Subgroup"),
             yaxis = list(title = "Standardised Incidence Ratio (SIR)"),
             xaxis = list(title = "Subgroup"),
             showlegend = FALSE) %>% 
      config(displayModeBar = FALSE)  # This hides the toolbox
    
    p
  })
  
}

shinyApp(ui, server)


```

the Okabe and Ito palette for color-blindness suitability.
The plotly plot is interactive, and the toolbox is hidden.
This layout should fit well on an HD screen (1080p) without scrolling due to the responsive design of Shiny and Plotly.

```{r}

# Colorblind-friendly colors - Okabe and Ito palette
cb_palette <- c('Males' = '#E69F00', 'Females' = '#56B4E9')

ui <- fluidPage(
  titlePanel("Melanoma Mortality in Victoria 1982-2021"),
  sidebarLayout(
    sidebarPanel(
      selectInput("sexInput", "Select Gender:", 
                  choices = unique(mortality_data_long$Sex), 
                  selected = c("Males", "Females"),
                  multiple = TRUE),
      selectInput("ageGroupInput", "Select Age Group:",
                  choices = unique(mortality_data_long$`Age Group`),
                  selected = "20-24",
                  multiple = TRUE)
    ),
    mainPanel(
      plotlyOutput("mortalityPlot"),
      tags$p("Source: Victorian Cancer Registry (2022)", style = "color:gray;")
    )
  )
)

server <- function(input, output) {

  output$mortalityPlot <- renderPlotly({
    filtered_data <- mortality_data_long %>%
      filter(`Age Group` %in% input$ageGroupInput, Sex %in% input$sexInput)

    p <- filtered_data %>%
      plot_ly(x = ~Year,
              y = ~Value,
              color = ~Sex,
              colors = cb_palette,
              type = "scatter",
              mode = "lines+markers",
              hoverinfo = "text",
              text = ~paste("Year:", Year, "<br>Sex:", Sex, "<br>Age Group:", `Age Group`,
                            "<br>Total Deaths:", `Total deaths`, "<br>ASR:", ASR, "<br>Crude Rate:", `Crude rate`)) %>%
      layout(title = "Melanoma Mortality in Victoria by Year and Gender",
             xaxis = list(title = "Year"),
             yaxis = list(title = "Age Specific Rate")) %>%
      config(displayModeBar = FALSE)  # Hides the plotly default toolbox

    p
  })
}

shinyApp(ui = ui, server = server)
```



```{r}
library(shiny)
library(plotly)
library(dplyr)

# Colorblind-friendly colors - Okabe and Ito palette
cb_palette <- c('Males' = '#E69F00', 'Females' = '#56B4E9')

ui <- fluidPage(
  titlePanel("Melanoma Incidence and Mortality in Victoria (1982-2021)"),
  sidebarLayout(
    sidebarPanel(
      selectInput("sexInput", "Select Gender:", 
                  choices = unique(mortality_data_long$Sex), 
                  selected = c("Males", "Females"),
                  multiple = TRUE),
      selectInput("ageGroupInput", "Select Age Group:",
                  choices = unique(mortality_data_long$`Age Group`),
                  selected = "20-24"),
      wellPanel(
        h4("Definitions:"),
        tags$ul(
          tags$li("Age-standardised rate (ASR): Provides the capacity to compare..."),
          tags$li("Crude rate (CR): The number of diagnoses..."),
          tags$li("Age-specific rate: Number of diagnoses..."),
          tags$li("Standardised incidence ratio (SIR): A Standardised Incidence Ratio...")
        )
      )
    ),
    mainPanel(
      fluidRow(
        column(6, plotlyOutput("timeSeriesPlot")),
        column(6, plotlyOutput("mortalityPlot"))
      ),
      tags$p("Source: Victorian Cancer Registry (2022)", style = "color:gray;")
    )
  )
)

server <- function(input, output) {

  # Filter data for Incidence Plot
  filtered_data_incidence <- reactive({
    data_long[data_long$Sex %in% input$sexInput & data_long$AgeGroup == input$ageGroupInput,]
  })

  # Filter data for Mortality Plot
  filtered_data_mortality <- reactive({
    mortality_data_long %>%
      filter(`Age Group` == input$ageGroupInput, Sex %in% input$sexInput)
  })

  # Render Incidence Plot
  output$timeSeriesPlot <- renderPlotly({
    plot_ly(data = filtered_data_incidence(), x = ~Year, y = ~Cases, color = ~Sex, colors = cb_palette, 
            type = "scatter", mode = "lines",
            hoverinfo = "text",
            text = ~paste("Year:", Year, "<br>Sex:", Sex, "<br>Age Group:", AgeGroup, "<br>Cases:", Cases)) %>%
      layout(title = "Yearly Melanoma Cases in Victoria by Gender",
             xaxis = list(title = "Year"),
             yaxis = list(title = "Number of Cases")) %>%
      config(displayModeBar = FALSE)  # Hides the plotly default toolbox
  })

  # Render Mortality Plot
  output$mortalityPlot <- renderPlotly({
    p <- filtered_data_mortality() %>%
      plot_ly(x = ~Year,
              y = ~Value,
              color = ~Sex,
              colors = cb_palette,
              type = "scatter",
              mode = "lines+markers",
              hoverinfo = "text",
              text = ~paste("Year:", Year, "<br>Sex:", Sex, "<br>Age Group:", `Age Group`,
                            "<br>Total Deaths:", `Total deaths`, "<br>ASR:", ASR, "<br>Crude Rate:", `Crude rate`)) %>%
      layout(title = "Melanoma Mortality in Victoria by Year and Gender",
             xaxis = list(title = "Year"),
             yaxis = list(title = "Age Specific Rate")) %>%
      config(displayModeBar = FALSE)  # Hides the plotly default toolbox

    p
  })
}

shinyApp(ui = ui, server = server)

```

